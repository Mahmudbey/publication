name: Update Academic Stats

on:
  schedule:
    - cron: "0 0 * * 1"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-stats:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install requests PyYAML

      - name: Fetch Data with Fallback
        env:
          SCOPUS_API_KEY: ${{ secrets.SCOPUS_API_KEY }}
          SCOPUS_ID: "57432107100"
          ORCID_ID: "0000-0002-3326-4390"
        run: |
          python -c "
          import requests, yaml, os

          # Boshlang'ich (default) qiymatlar
          stats = {
              'scopus': {'h_index': 'N/A', 'citations': 'N/A', 'documents': 'N/A'},
              'orcid': {'works_count': 0, 'id': os.environ['ORCID_ID']}
          }

          # 1. Scopus API - 401 xatoligini chetlab o'tishga urinish
          try:
              headers = {
                  'X-ELS-APIKey': os.environ['SCOPUS_API_KEY'],
                  'Accept': 'application/json'
              }
              # Author Retrieval o'rniga Search API ni sinab ko'ramiz (ba'zan u ochiqroq bo'ladi)
              search_url = f'https://api.elsevier.com/content/search/scopus?query=AU-ID({os.environ[\"SCOPUS_ID\"]})'
              r = requests.get(search_url, headers=headers, timeout=15)
              
              if r.status_code == 200:
                  res = r.json().get('search-results', {})
                  count = res.get('opensearch:totalResults', 'N/A')
                  stats['scopus']['documents'] = count
                  print('Scopus Search success')
              else:
                  print(f'Scopus API blocked (Status {r.status_code}). Institutional IP required.')
          except Exception as e:
              print(f'Scopus connection error: {e}')

          # 2. ORCID - Bu doim ishlaydi
          try:
              r = requests.get(f'https://pub.orcid.org/v3.0/{os.environ[\"ORCID_ID\"]}/works', 
                               headers={'Accept': 'application/json'}, timeout=15)
              if r.status_code == 200:
                  stats['orcid']['works_count'] = len(r.json().get('group', []))
                  print('ORCID success')
          except:
              print('ORCID failed')

          # Faylga yozish
          os.makedirs('_data', exist_ok=True)
          with open('_data/stats.yml', 'w') as f:
              yaml.dump(stats, f)
          "

      - name: Commit and Push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add _data/stats.yml
          git diff --staged --quiet || (git commit -m "Update stats [skip ci]" && git push)
