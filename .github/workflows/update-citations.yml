name: Update Academic Stats

on:
  schedule:
    - cron: "0 0 * * 1"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-stats:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install requests PyYAML

      - name: Fetch Data
        env:
          SCOPUS_API_KEY: ${{ secrets.SCOPUS_API_KEY }}
          SCOPUS_ID: "57432107100"
          ORCID_ID: "0000-0002-3326-4390"
        run: |
          python -c "
          import requests, yaml, os

          # Avvalgi ma'lumotlarni o'qish (agar bo'lsa)
          file_path = '_data/stats.yml'
          if os.path.exists(file_path):
              with open(file_path, 'r') as f:
                  stats = yaml.safe_load(f) or {}
          else:
              stats = {'scopus': {'h_index': 0, 'citations': 0, 'documents': 0}, 'orcid': {}}

          # 1. ORCID Yangilash (Bu doim ishlaydi)
          try:
              orcid_id = os.environ['ORCID_ID']
              r = requests.get(f'https://pub.orcid.org/v3.0/{orcid_id}/works', headers={'Accept': 'application/json'}, timeout=15)
              if r.status_code == 200:
                  stats['orcid'] = {'works_count': len(r.json().get('group', [])), 'id': orcid_id}
                  print('✅ ORCID updated')
          except: print('⚠️ ORCID failed')

          # 2. Scopus (Faqatgina ruxsat bo'lsa yangilaydi, bo'lmasa eski qiymatni saqlaydi)
          try:
              headers = {'X-ELS-APIKey': os.environ['SCOPUS_API_KEY'], 'Accept': 'application/json'}
              url = f'https://api.elsevier.com/content/author/author_id/{os.environ[\"SCOPUS_ID\"]}'
              r = requests.get(url, headers=headers, timeout=15)
              if r.status_code == 200:
                  d = r.json()['author-retrieval-response'][0]['coredata']
                  stats['scopus'] = {
                      'h_index': int(d.get('h-index', stats['scopus'].get('h_index', 0))),
                      'citations': int(d.get('citation-count', stats['scopus'].get('citations', 0))),
                      'documents': int(d.get('document-count', stats['scopus'].get('documents', 0)))
                  }
                  print('✅ Scopus updated')
              else:
                  print(f'ℹ️ Scopus blocked (401). Keeping existing data.')
          except: print('⚠️ Scopus connection error')

          os.makedirs('_data', exist_ok=True)
          with open(file_path, 'w') as f:
              yaml.dump(stats, f)
          "

      - name: Commit and Push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add _data/stats.yml
          git commit -m "Update stats (ORCID auto, Scopus fallback)" || exit 0
          git push
